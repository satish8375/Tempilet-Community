name: Auto Update Template Index

on:
  # à¤…à¤¬ à¤¯à¤¹ à¤•à¥‡à¤µà¤² à¤¤à¤¬ à¤šà¤²à¥‡à¤—à¤¾ à¤œà¤¬ 'main' à¤¬à¥à¤°à¤¾à¤‚à¤š à¤®à¥‡à¤‚ à¤¬à¤¦à¤²à¤¾à¤µ (Merge) à¤¹à¥‹à¤—à¤¾
  push:
    branches:
      - main
    paths:
      - 'templates/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # à¤¸à¥à¤°à¤•à¥à¤·à¤¾ à¤•à¥‡ à¤²à¤¿à¤: à¤šà¥‡à¤• à¤•à¤°à¥‡à¤‚ à¤•à¤¿ à¤•à¥à¤¯à¤¾ JSON à¤¸à¤¹à¥€ (Valid) à¤¹à¥ˆ
      - name: Validate JSON Files
        run: |
          shopt -s nullglob
          for file in templates/*.json; do
            jq . "$file" > /dev/null || (echo "âŒ Error: $file is not a valid JSON" && exit 1)
          done

      - name: Regenerate templates.csv
        run: |
          echo "id,template_name,author_name,json_url,preview_url,tags" > templates.csv
          count=1
          repo_url="https://raw.githubusercontent.com/${{ github.repository }}/main"

          shopt -s nullglob
          for file in templates/*.json; do
            filename=$(basename "$file")
            name_only="${filename%.*}"
            
            # JSON à¤¸à¥‡ à¤¨à¤¾à¤® à¤¨à¤¿à¤•à¤¾à¤²à¥‡à¤‚, à¤¨à¤¹à¥€à¤‚ à¤¤à¥‹ à¤«à¤¾à¤‡à¤² à¤•à¤¾ à¤¨à¤¾à¤® à¤‡à¤¸à¥à¤¤à¥‡à¤®à¤¾à¤² à¤•à¤°à¥‡à¤‚
            template_name=$(jq -r '.name // empty' "$file" || echo "$name_only")
            if [ -z "$template_name" ] || [ "$template_name" == "null" ]; then template_name="$name_only"; fi
            
            author_name="Community"
            json_url="${repo_url}/templates/${filename}"
            preview_url="${repo_url}/previews/${name_only}.png"
            
            echo "$count,$template_name,$author_name,$json_url,$preview_url,General" >> templates.csv
            count=$((count + 1))
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Tempilet-Bot"
          git config --global user.email "bot@tempilet.com"
          git add templates.csv
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update index [skip ci]" && git push)
