name: Auto Update Template Index

# ‡§Ø‡§π ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§§‡§¨ ‡§ö‡§≤‡•á‡§ó‡•Ä ‡§ú‡§¨ ‡§ï‡•ã‡§à /templates ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§´‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° (Push) ‡§ï‡§∞‡•á‡§ó‡§æ
on:
  push:
    paths:
      - 'templates/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡•ã ‡§´‡§æ‡§á‡§≤ ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§®‡§æ
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Regenerate templates.csv
        run: |
          # 1. CSV ‡§ï‡•á ‡§π‡•á‡§°‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§´‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡•á‡§Ç)
          echo "id,template_name,author_name,json_url,preview_url,tags" > templates.csv

          # 2. ‡§ï‡§æ‡§â‡§®‡•ç‡§ü‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
          count=1
          repo_url="https://raw.githubusercontent.com/${{ github.repository }}/main"

          # 3. /templates ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§ï‡•Ä ‡§∏‡§≠‡•Ä .json ‡§´‡§æ‡§á‡§≤‡•ã‡§Ç ‡§™‡§∞ ‡§≤‡•Ç‡§™ ‡§ö‡§≤‡§æ‡§è‡§Ç
          # ‡§π‡§Æ 'null' ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡•á‡§ï ‡§≠‡•Ä ‡§≤‡§ó‡§æ‡§è‡§Ç‡§ó‡•á
          shopt -s nullglob
          for file in templates/*.json; do
            filename=$(basename "$file")
            name_only="${filename%.*}"
            
            # JSON ‡§´‡§æ‡§á‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∏‡•á "name" ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç (jq ‡§ü‡•Ç‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á)
            # ‡§Ö‡§ó‡§∞ ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§§‡§æ, ‡§§‡•ã ‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§π‡•Ä ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç
            template_name=$(jq -r '.name // empty' "$file" || echo "$name_only")
            if [ -z "$template_name" ]; then template_name="$name_only"; fi
            
            author_name="Community"
            
            # URL ‡§ï‡§æ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§ï‡§∞‡•á‡§Ç
            json_url="${repo_url}/templates/${filename}"
            preview_url="${repo_url}/previews/${name_only}.png"
            
            # 4. CSV ‡§Æ‡•á‡§Ç ‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§ú‡•ã‡•ú‡•á‡§Ç
            echo "$count,$template_name,$author_name,$json_url,$preview_url,General" >> templates.csv
            
            count=$((count + 1))
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Tempilet-Bot"
          git config --global user.email "bot@tempilet.com"
          git add templates.csv
          # ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§ï‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§π‡•Å‡§è ‡§π‡•ã‡§Ç
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ Auto-update index [skip ci]" && git push)
